{% extends "base.html" %} {% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–æ—Ç–∞ –∏ –•–æ—Å—Ç–æ–≤{% endblock %}
{% block content %}

<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="text-secondary">–ü–∞–Ω–µ–ª—å, –±–æ—Ç—ã, –ø–ª–∞—Ç–µ–∂–∏, —Ö–æ—Å—Ç—ã –∏ –∫–æ–Ω—Ç–µ–Ω—Ç</div>
    </div>
  </div>
  <div class="hr-text"></div>
</div>

{# –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –∑–∞–ø—É—Å–∫—É #}
{% if all_settings_ok and support_settings_ok %}
  <div class="alert alert-success" role="alert">
    ‚úÖ –í–µ–±-–ø–∞–Ω–µ–ª—å –∏ –æ–±–∞ –±–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å.
  </div>
{% else %}
  <div class="alert alert-warning" role="alert">
    ‚ö†Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.
    <div class="small text-secondary mt-1">
      –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç: {{ '–æ–∫' if all_settings_ok else '–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫' }} ‚Ä¢ Support-–±–æ—Ç: {{ '–æ–∫' if support_settings_ok else '–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫' }}
    </div>
  </div>
{% endif %}

{# –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ #}
<div class="card glass mb-3">
  <div class="card-body py-2">
    <ul class="nav nav-pills">
      <li class="nav-item"><a class="nav-link" href="#panel">–ü–∞–Ω–µ–ª—å</a></li>
      <li class="nav-item"><a class="nav-link" href="#bot">–ë–æ—Ç</a></li>
      <li class="nav-item"><a class="nav-link" href="#support-bot">Support-–±–æ—Ç</a></li>
      <li class="nav-item"><a class="nav-link" href="#payments">–ü–ª–∞—Ç–µ–∂–∏</a></li>
      <li class="nav-item"><a class="nav-link" href="#hosts">–•–æ—Å—Ç—ã/–¢–∞—Ä–∏—Ñ—ã</a></li>
      <li class="nav-item"><a class="nav-link" href="#referrals">–†–µ—Ñ–µ—Ä–∞–ª—ã</a></li>
      <li class="nav-item"><a class="nav-link" href="#trial">–¢—Ä–∏–∞–ª</a></li>
      <li class="nav-item"><a class="nav-link" href="#content">–ö–æ–Ω—Ç–µ–Ω—Ç</a></li>
    </ul>
  </div>
  </div>

<style>
  .collapse { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 220ms ease, opacity 220ms ease; }
  .collapse.show { opacity: 1; }
  .plan-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .plan-label { margin-right: 4px; min-width: 200px; }
  .plan-edit form { display: inline-flex; gap: 6px; align-items: center; padding-top: 6px; }
  .button-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
  .button-secondary:hover { background: #e9e9e9; }
  .plan-edit-toggle[aria-expanded="true"] { transform: rotate(0deg); }
  .plan-edit-toggle { transition: transform 180ms ease; }

  .soft-select select { position: absolute; inset: 0; opacity: 0; pointer-events: none; }
  #backup-date.badge { border: 0; }
  @media (max-width: 767.98px){
    #backup-date.badge { margin-top: 6px; }
  }

  #btn-pick-file.btn,
  #picked-file-name.form-control {
    border-color: rgba(255,255,255,.14) !important;
    box-shadow: none !important;
    background: rgba(17,20,28,.45) !important;
    color: inherit;
  }
  #btn-pick-file.btn { border-right-width: 0 !important; }
  #picked-file-name.form-control { border-left-width: 0 !important; }
  .input-group > .btn.pill.rounded-start { border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important; }
  .input-group > .form-control.pill.rounded-end { border-top-left-radius: 0 !important; border-bottom-left-radius: 0 !important; }
  #btn-pick-file.btn:hover,
  #btn-pick-file.btn:focus,
  #picked-file-name.form-control:focus {
    background: rgba(17,20,28,.52) !important;
    border-color: rgba(255,255,255,.18) !important;
    box-shadow: none !important;
  }
</style>

<div class="settings-container">
	<div class="settings-column-left">
		<!-- –ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (—Ö–æ—Å—Ç—ã –∏ —Ç–∞—Ä–∏—Ñ—ã) -->
	</div>

	<div class="settings-column-right">
        <form action="{{ url_for('settings_page') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="next_hash" id="settings-next-hash" value="#panel" />

            <!-- —Å–µ–∫—Ü–∏–∏ panel, bot, support-bot, referrals, trial -->

			<section class="settings-section" id="payments">
				<div class="card">
					<div class="card-header"><h2 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–ª–∞—Ç–µ–∂–Ω—ã—Ö –°–∏—Å—Ç–µ–º</h2></div>
					<div class="card-body">
						<h3 class="h4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ YooKassa</h3>
						<div class="mb-3">
							<label class="form-label" for="receipt_email">–ü–æ—á—Ç–∞ –¥–ª—è —á–µ–∫–æ–≤</label>
							<input class="form-control" type="text" id="receipt_email" name="receipt_email" value="{{ settings.receipt_email or '' }}" />
						</div>
						<div class="mb-3">
							<label class="form-label" for="yookassa_shop_id">YooKassa Shop ID</label>
							<input class="form-control" type="text" id="yookassa_shop_id" name="yookassa_shop_id" value="{{ settings.yookassa_shop_id or '' }}" />
						</div>
						<div class="mb-3 password-wrapper">
							<label class="form-label" for="yookassa_secret_key">YooKassa Secret Key</label>
							<div class="d-flex gap-2">
								<input class="form-control" type="password" id="yookassa_secret_key" name="yookassa_secret_key" value="{{ settings.yookassa_secret_key or '' }}" />
								<button type="button" class="btn btn-outline-secondary toggle-password">üëÅÔ∏è</button>
							</div>
						</div>
						<div class="mb-3">
							<input type="hidden" name="sbp_enabled" value="false" />
							<div class="form-check">
								<input class="form-check-input" type="checkbox" id="sbp_enabled" name="sbp_enabled" value="true" {% if settings.sbp_enabled == 'true' %}checked{% endif %}>
								<label class="form-check-label" for="sbp_enabled">–í–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ –°–ë–ü</label>
							</div>
						</div>

						<h3 class="h4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ CryptoBot</h3>
						<div class="mb-3 password-wrapper">
							<label class="form-label" for="cryptobot_token">CryptoBot Token</label>
							<div class="d-flex gap-2">
								<input class="form-control" type="password" id="cryptobot_token" name="cryptobot_token" value="{{ settings.cryptobot_token or '' }}" />
								<button type="button" class="btn btn-outline-secondary toggle-password">üëÅÔ∏è</button>
							</div>
						</div>

						<h3 class="h4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Heleket</h3>
						<div class="mb-3">
							<label class="form-label" for="heleket_merchant_id">Heleket Merchant ID</label>
							<input class="form-control" type="text" id="heleket_merchant_id" name="heleket_merchant_id" value="{{ settings.heleket_merchant_id or '' }}" />
						</div>
						<div class="mb-3 password-wrapper">
							<label class="form-label" for="heleket_api_key">Heleket API Key</label>
							<div class="d-flex gap-2">
								<input class="form-control" type="password" id="heleket_api_key" name="heleket_api_key" value="{{ settings.heleket_api_key or '' }}" />
								<button type="button" class="btn btn-outline-secondary toggle-password">üëÅÔ∏è</button>
							</div>
						</div>

						<h3 class="h4">Telegram Stars</h3>
						<div class="mb-3">
						  <input type="hidden" name="stars_enabled" value="false" />
						  <div class="form-check">
						    <input class="form-check-input" type="checkbox" id="stars_enabled" name="stars_enabled" value="true" {% if settings.stars_enabled == 'true' %}checked{% endif %}>
						    <label class="form-check-label" for="stars_enabled">–í–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É –≤ Telegram Stars</label>
						  </div>
						</div>
						<div class="mb-3">
						  <label class="form-label" for="stars_per_rub">–ö—É—Ä—Å Stars –∑–∞ 1 RUB</label>
						  <div class="input-group with-suffix">
						    <input class="form-control pill-md" type="number" step="0.01" min="0" id="stars_per_rub" name="stars_per_rub" value="{{ settings.stars_per_rub or '1' }}" />
						    <span class="input-group-text">‚≠ê</span>
						  </div>
						  <div class="form-text text-secondary">–°–∫–æ–ª—å–∫–æ –∑–≤—ë–∑–¥ —Å–ø–∏—Å—ã–≤–∞—Ç—å –∑–∞ 1 —Ä—É–±–ª—å. –ù–∞–ø—Ä–∏–º–µ—Ä, 1.5 –æ–∑–Ω–∞—á–∞–µ—Ç 1.5‚≠ê –∑–∞ 1 RUB.</div>
						</div>
						<div class="mb-3">
						  <label class="form-label" for="stars_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–Ω–≤–æ–π—Å–∞ Stars</label>
						  <input class="form-control" type="text" id="stars_title" name="stars_title" value="{{ settings.stars_title or '' }}" />
						</div>
						<div class="mb-3">
						  <label class="form-label" for="stars_description">–û–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ Stars</label>
						  <input class="form-control" type="text" id="stars_description" name="stars_description" value="{{ settings.stars_description or '' }}" />
						</div>

						<h3 class="h4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ YooMoney</h3>
						<div class="mb-3">
						  <input type="hidden" name="yoomoney_enabled" value="false" />
						  <div class="form-check">
						    <input class="form-check-input" type="checkbox" id="yoomoney_enabled" name="yoomoney_enabled" value="true" {% if settings.yoomoney_enabled == 'true' %}checked{% endif %}>
						    <label class="form-check-label" for="yoomoney_enabled">–í–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ YooMoney (–∫–æ—à–µ–ª—ë–∫)</label>
						  </div>
						</div>
						<div class="mb-3">
						  <label class="form-label" for="yoomoney_wallet">–ö–æ—à–µ–ª—ë–∫ YooMoney</label>
						  <input class="form-control" type="text" id="yoomoney_wallet" name="yoomoney_wallet" value="{{ settings.yoomoney_wallet or '' }}" />
						</div>
						<div class="mb-3 password-wrapper">
						  <label class="form-label" for="yoomoney_api_token">API Token YooMoney</label>
						  <div class="d-flex gap-2">
						    <input class="form-control" type="password" id="yoomoney_api_token" name="yoomoney_api_token" value="{{ settings.yoomoney_api_token or '' }}" />
						    <button type="button" class="btn btn-outline-secondary toggle-password">üëÅÔ∏è</button>
						  </div>
						</div>
					</div>
				</div>
			</section>

            <!-- —Å–µ–∫—Ü–∏–∏ content –∏ –ø—Ä–æ—á–∏–µ -->

        </form>
    </div>
</div>

<script>
  (function(){
    const form = document.querySelector('.settings-column-right form[action*="/settings"]');
    if (!form) return;
    const hidden = form.querySelector('#settings-next-hash');
    form.addEventListener('submit', function(){
      let hash = location.hash || '';
      if (!hash){
        const active = document.querySelector('.nav.nav-pills .nav-link.active');
        if (active && active.getAttribute('href')) hash = active.getAttribute('href');
      }
      if (!hash) hash = '#panel';
      if (hidden) hidden.value = hash;
    });
  })();
</script>

<script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.plan-edit-toggle');
    if (!btn) return;
    const targetSel = btn.getAttribute('data-target');
    if (!targetSel) return;
    const panel = document.querySelector(targetSel);
    if (!panel) return;

    const hostSection = btn.closest('.plans-section');
    if (hostSection) {
      hostSection.querySelectorAll('.plan-edit.collapse.show').forEach(other => {
        if (other !== panel) {
          const otherBtn = hostSection.querySelector(`.plan-edit-toggle[data-target="#${other.id}"]`);
          if (otherBtn) otherBtn.setAttribute('aria-expanded', 'false');
          other.style.maxHeight = other.scrollHeight + 'px';
          requestAnimationFrame(() => {
            other.style.maxHeight = '0px';
            setTimeout(() => { other.classList.remove('show'); }, 220);
          });
        }
      });
    }

    const isOpen = panel.classList.contains('show');
    if (!isOpen) {
      panel.classList.add('show');
      panel.style.maxHeight = panel.scrollHeight + 'px';
      setTimeout(() => { panel.style.maxHeight = 'none'; }, 230);
      btn.setAttribute('aria-expanded', 'true');
    } else {
      panel.style.maxHeight = panel.scrollHeight + 'px';
      requestAnimationFrame(() => {
        panel.style.maxHeight = '0px';
        setTimeout(() => { panel.classList.remove('show'); }, 220);
      });
      btn.setAttribute('aria-expanded', 'false');
    }
  });
</script>

{% endblock %}